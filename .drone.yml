---
kind: pipeline
type: docker
name: linux

platform:
  os: linux
  arch: amd64

event:
  - push

steps:
  - name: restore_cache
    image: meltwater/drone-cache
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws-key-id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws-secret-key
    pull: true
    settings:
      restore: true
      cache_key: '{{ .Commit.Branch }}'
      bucket:
        from_secret: aws-cache-bucket
      region:
        from_secret: aws-region
      mount:
        - .m2
        - src/test/resources/big
        - blast

  - name: deploy
    image: maven:3-adoptopenjdk-8
    commands:
      - df -h
      - mkdir -p $${HOME}/.m2
      - echo '<settings><servers><server><id>therepo</id><username>$${repo.user}</username><password>$${repo.pass}</password></server></servers></settings>' > $${HOME}/.m2/settings.xml
      - mvn deploy -DskipTests -DaltDeploymentRepository=therepo::default::$${DEPLOY_REPO} -Drepo.user=$${DEPLOY_USER} -Drepo.pass=$${DEPLOY_PASS} -Drevision=${DRONE_COMMIT_SHA:0:7}
    environment:
      MAVEN_OPTS: "-Dmaven.repo.local=/drone/src/.m2"
      DEPLOY_REPO:
        from_secret: maven-deploy-repo
      DEPLOY_USER:
        from_secret: maven-deploy-user
      DEPLOY_PASS:
        from_secret: maven-deploy-pass
    when:
      event:
        exclude:
          - pull_request

#  - name: build_and_test
#    image: maven:3-adoptopenjdk-8
#    commands:
#      - ./init.sh
#      - mvn clean test
#    environment:
#      MAVEN_OPTS: "-Dmaven.repo.local=/drone/src/.m2"

  - name: rebuild_cache
    image: meltwater/drone-cache
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws-key-id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws-secret-key
    settings:
      rebuild: true
      cache_key: '{{ .Commit.Branch }}'
      bucket:
        from_secret: aws-cache-bucket
      region:
        from_secret: aws-region
      mount:
        - .m2
        - src/test/resources/big
        - blast

---
kind: signature
hmac: 51266f5c8f242a8b0dc309f328558806107fa72473331147f5c6847465f8d0f2

...
